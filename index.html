<!DOCTYPE html>
<html>
<head>
  <title>CO Monitoring Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    /* Your existing CSS remains unchanged */
    #map { 
      height: 600px; 
      width: 100%; 
      background: #f0f0f0;
    }
    .map-header {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
    }
    /* ... rest of your CSS ... */
  </style>
</head>
<body>
  <div id="map">
    <div class="map-header">
      <input type="text" id="datePicker" placeholder="Select date">
    </div>
    <div id="loading">Loading CO data...</div>
  </div>

  <!-- Scripts loaded at the end -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Authentication Script -->
  <script>
    // OAuth Configuration
    const COPERNICUS_AUTH = {
      clientId: 'sh-3e397c85-30e1-4067-9bec-975aa62d574a', 
      clientSecret: 'oEGik5bM249xxsAowSiSvwmK43qdqsBQ',
      tokenUrl: 'https://identity.dataspace.copernicus.eu/auth/realms/CDSE/protocol/openid-connect/token'
    };

    let accessToken = null;
    let tokenExpiry = null;

    async function getAccessToken() {
      if (accessToken && Date.now() < tokenExpiry) {
        return accessToken;
      }

      try {
        const response = await fetch(COPERNICUS_AUTH.tokenUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            client_id: COPERNICUS_AUTH.clientId,
            client_secret: COPERNICUS_AUTH.clientSecret,
            grant_type: 'client_credentials'
          })
        });

        if (!response.ok) throw new Error(`Auth failed: ${response.status}`);
        
        const data = await response.json();
        accessToken = data.access_token;
        tokenExpiry = Date.now() + (data.expires_in * 1000) - 60000;
        return accessToken;
      } catch (error) {
        console.error("Token error:", error);
        alert("Authentication failed. Check console for details.");
        throw error;
      }
    }
  </script>

  <!-- Main Map Script -->
  <script>
    // 1. INITIALIZE MAP
    const map = L.map('map').setView([20.27594, -74.66599], 4);

    // 2. BASE MAP
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // 3. COPERNICUS WMS LAYER (Modified to use auth token)
    let copernicusWMS = null;

    async function createCOLayer(date) {
      const token = await getAccessToken();
      return L.tileLayer.wms('https://wms.dataspace.copernicus.eu/wms', {
        layers: 'S5_CO_CDAS',
        styles: 'RASTER/CO_VISUALIZED',
        format: 'image/png',
        transparent: true,
        version: '1.3.0',
        access_token: token,
        time: date
      });
    }

    // 4. DATE PICKER
    const datePicker = flatpickr("#datePicker", {
      dateFormat: "Y-m-d",
      defaultDate: "2024-01-15",
      maxDate: "today",
      onChange: async function(selectedDates) {
        const date = selectedDates[0].toISOString().split('T')[0];
        await updateCOLayer(date);
      }
    });

    // 5. UPDATED LAYER FUNCTION (now async)
    async function updateCOLayer(date) {
      document.getElementById('loading').style.display = 'block';
      
      try {
        // Remove old layer if exists
        if (copernicusWMS) {
          map.removeLayer(copernicusWMS);
        }
        
        // Create new layer with fresh token
        copernicusWMS = await createCOLayer(date);
        copernicusWMS.addTo(map);
        
        // Set up auto-refresh (every 5 minutes)
        if (!window.tokenRefreshInterval) {
          window.tokenRefreshInterval = setInterval(async () => {
            const newToken = await getAccessToken();
            copernicusWMS.setParams({ access_token: newToken });
          }, 300000);
        }
        
      } catch (error) {
        console.error("CO Layer Error:", error);
        alert("Failed to load CO data. Please try again later.");
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }

    // 6. LEGEND (unchanged)
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function() {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <h4>CO Column (mol/m²)</h4>
        <div><i style="background:#2b08a8"></i> 0.00-0.02</div>
        <!-- ... rest of your legend ... -->
      `;
      return div;
    };
    legend.addTo(map);

    // 7. INITIAL LOAD (now async)
    (async function init() {
      try {
        await updateCOLayer(datePicker.input.value);
      } catch (error) {
        console.error("Initialization failed:", error);
      }
    })();

    // 8. ERROR HANDLING
    if (copernicusWMS) {
      copernicusWMS.on('load', () => {
        document.getElementById('loading').style.display = 'none';
      });

      copernicusWMS.on('tileerror', () => {
        alert('Error loading CO data. Please check:\n1. Your internet connection\n2. Access token\n3. Date availability');
      });
    }
  </script>
</body>
</html>
