<!DOCTYPE html>
<html>
<head>
  <title>CO Monitoring Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    #map { 
      height: 600px; 
      width: 100%; 
      background: #f0f0f0; /* Fallback while loading */
    }
    .map-header {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
    }
    #loading {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 15px 25px;
      border-radius: 5px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      z-index: 1000;
      font-weight: bold;
      color: #2c3e50;
    }
    .legend {
      padding: 10px 15px;
      background: rgba(255,255,255,0.9);
      border-radius: 5px;
      line-height: 1.6;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .legend h4 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }
    .legend i {
      width: 20px;
      height: 20px;
      display: inline-block;
      margin-right: 8px;
      vertical-align: middle;
      border: 1px solid #555;
    }
    #datePicker {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="map">
    <div class="map-header">
      <input type="text" id="datePicker" placeholder="Select date">
    </div>
    <div id="loading">Loading CO data...</div>
  </div>

  <!-- Scripts loaded at the end -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // 1. INITIALIZE MAP (Same view as Copernicus browser)
    const map = L.map('map').setView([20.27594, -74.66599], 4);

    // 2. BASE MAP
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // 3. COPERNICUS WMS LAYER (Key change for exact visualization)
    const copernicusWMS = L.tileLayer.wms('https://wms.dataspace.copernicus.eu/wms', {
      layers: 'S5_CO_CDAS',
      styles: 'RASTER/CO_VISUALIZED',
      format: 'image/png',
      transparent: true,
      version: '1.3.0',
      attribution: 'Copernicus Atmosphere Monitoring Service'
    });

    // 4. DATE PICKER WITH ENHANCED OPTIONS
    const datePicker = flatpickr("#datePicker", {
      dateFormat: "Y-m-d",
      defaultDate: "2024-01-15",
      maxDate: "today",
      onChange: function(selectedDates) {
        const date = selectedDates[0].toISOString().split('T')[0];
        updateCOLayer(date);
      }
    });

    // 5. UPDATE WMS LAYER WITH DATE
    function updateCOLayer(date) {
      document.getElementById('loading').style.display = 'block';
      
      copernicusWMS.setParams({
        time: date,
        // Optional: Add cloud coverage filter
        // cql_filter: "cloudCover<=30"
      });
      
      if (!map.hasLayer(copernicusWMS)) {
        copernicusWMS.addTo(map);
      }
      
      // Hide loading after tiles load
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
      }, 1000);
    }

    // 6. LEGEND (Matches Copernicus exactly)
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function() {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <h4>CO Column (mol/m²)</h4>
        <div><i style="background:#2b08a8"></i> 0.00-0.02</div>
        <div><i style="background:#1b4df0"></i> 0.02-0.04</div>
        <div><i style="background:#00a8f0"></i> 0.04-0.06</div>
        <div><i style="background:#00f0a8"></i> 0.06-0.08</div>
        <div><i style="background:#a8f000"></i> 0.08-0.10</div>
        <div><i style="background:#f0a800"></i> 0.10-0.12</div>
        <div><i style="background:#f00008"></i> >0.12</div>
        <div style="margin-top:8px;font-size:0.8em;color:#666">Sentinel-5P Data</div>
      `;
      return div;
    };
    legend.addTo(map);

    // 7. INITIAL LOAD
    updateCOLayer(datePicker.input.value);

    // 8. ERROR HANDLING
    copernicusWMS.on('load', () => {
      document.getElementById('loading').style.display = 'none';
    });

    copernicusWMS.on('tileerror', () => {
      alert('Error loading CO data. Please check:\n1. Your internet connection\n2. Access token (if required)\n3. Date availability');
    });
  </script>
</body>
</html>
